@{
    Layout = null;
    ViewBag.Default_C_NO = "13-AS206";
}

<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 預設每1小時重新整理一次 60 * 60 -->
    <!-- <meta http-equiv="refresh" content="3600"> -->
    <!-- #region html 禁止緩存 -->
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <!-- #endregion html 禁止緩存 -->
    <title>電子看板輪播</title>
    <script src="~/Assets/js/jquery-3.6.0.min.js"></script>
    <script src="~/Assets/lib/pdfjs-3.7.107/pdf.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            position: relative;
        }

        /* 全螢幕 */
        .full-screen {
            max-width: 100vw;
            height: 100%;
            bottom: 0;
        }

        /* 隱藏 */
        .disabled {
            display: none;
        }

        .top-left {
            position: absolute;
            top: 0;
            left: 0;
        }

        #ifPlayer {
            width: 100%;
            height: 100%;
            border: 0;
        }

        #statusLight {
            display: none;
            width: 12.5px;
            height: 12.5px;
            border-radius: 12.5px;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* 連線失敗 */
        .status-red {
            display: block !important;
            background-color: red;
        }

        /* 讀取失敗 */
        .status-yellow {
            display: block !important;
            background-color: yellow;
        }

        /* 使用者介面 */
        #UI {
            z-index: 99; /* 優先度 */
            right: 10px;
            top: 10px;
            position: absolute;
            opacity: 0;
        }

            #UI:hover {
                opacity: 1;
            }
    </style>
</head>
<body>
    <div id="UI">
        <button type="button" id="ui_previous">上一頁</button>
        <button type="button" id="ui_play">播放</button>
        <button type="button" id="ui_next">下一頁</button>
    </div>
    

    <img id="iPlayer" class="full-screen disabled" alt="your image" />
    <!--瀏覽器問題，必須先禁音才能自動播放-->
    <video id="vPlayer" class="full-screen disabled" autoplay muted></video>
    <!--必須符合CORS -> Same-origin policy 才能顯示，不然會顯示拒絕連線-->
    <iframe id="ifPlayer" class="full-screen disabled" scrolling="no"></iframe>
    <canvas id="cvPlayer" class="full-screen disabled"></canvas>
    <div>
        <div id="statusLight" class="disabled"></div>
        <div id="dMessage">
            <span style="margin-right: 10px;">電視編號</span><input type="text" id="url_C_NO" value="@ViewBag.Default_C_NO" />
            <br />
            <button type="button" id="url_build">送出</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = window.location.origin + '/Assets/lib/pdfjs-3.7.107/pdf.worker.js';

        // #region 參數
        // 電視編號
        var C_NO = null;
        // 播放器
        var iPlayer = document.getElementById('iPlayer');
        var vPlayer = document.getElementById('vPlayer');
        var ifPlayer = document.getElementById('ifPlayer');
        var cvPlayer = document.getElementById('cvPlayer');
        // 提示燈
        var statusLight = document.getElementById('statusLight');
        // 訊息
        var dMessage = document.getElementById('dMessage');
        // 播放參數
        var playFiles = null;                   // 檔案(型別, 位置)
        var pIndex = -1;                        // 目前播放
        var slideTime = 30;                     // 圖片切換(秒)
        // PDF參數
        var pdfDoc = null;
        var scale = 2;                          // 這邊可以縮放
        var ctx = cvPlayer.getContext('2d'/*, { willReadFrequently: true }*/);
        var pageNum = 0;
        // 版本
        var Version = undefined;
        var UpdateTime = null; // 節目最後更新時間
        // 切換用定時器，每秒更新
        var t_countdown = -1;   // 倒數時間
        var stop = true;        // 暫停
        var t = setInterval(function () {
            if (t_countdown >= 0) {
                if (t_countdown == 0) {
                    if (pdfDoc) {
                        pdfNextPage();
                    }
                    else {
                        next();
                    }
                }
                if (!stop) {
                    --t_countdown;
                }
            }
        }, 1000);
        // 更新用定時器，每秒更新
        var rt_countdown = -1;                     // 倒數時間
        var rt = setInterval(function () {
            if (rt_countdown >= 0) {
                if (rt_countdown == 0) {
                    refresh();
                }
                --rt_countdown;
            }
        }, 1000);
        // #endregion

        // #region API
        // 重整頁面，直接F5重整瀏覽器不會釋放記憶體
        function reload() {
            dispose();
            window.location.reload(true);
        }

        // 釋放
        function dispose() {
            // 停止定時器
            t_countdown = -1;
            rt_countdown = -1;
            // 隱藏上次播放
            $('.play').addClass('disabled').removeClass('play');
            // 釋放播放
            iPlayer.removeAttribute('src');     // 圖片
            vPlayer.removeAttribute('src');     // 影片
            ifPlayer.removeAttribute('src');    // 網頁
            // PDF
            pdfDispose();
            cvClear();
        }

        // #region 輪播控制
        function prePlay(prePlayFiles) {
            // 清除前次輪播
            dispose();

            playFiles = JSON.parse(prePlayFiles);

            play(); // 開始輪播

            // 每1小時更新1次播放內容
            preRefresh();
        }

        function play() {
            // 隱藏上次播放
            $('.play').addClass('disabled').removeClass('play');
            // 無能播放的檔案時結束播放
            if (playFiles.length === 0) {
                writeMessage('目前無播放節目');
                return;
            }
            // 輪播(超過從頭開始)
            if (++pIndex >= playFiles.length || pIndex < 0) {
                pIndex = 0;
            }
            // 播放決定
            switch (playFiles[pIndex].Type) {
                // 圖片
                case ".jpeg": case ".jpg": case ".png": case ".gif":
                    $(iPlayer).addClass('play').removeClass('disabled');
                    iPlay(playFiles[pIndex].Url);
                break;
                // 影片
                case ".mp4": case ".mov": case ".wmv":
                    $(vPlayer).addClass('play').removeClass('disabled');
                    vPlay(playFiles[pIndex].Url);
                break;
                // 網頁
                case ".html":
                    $(ifPlayer).addClass('play').removeClass('disabled');
                    ifPlay(playFiles[pIndex].Url, playFiles[pIndex].Second);
                break;
                // pdf
                case ".pdf":
                    $(cvPlayer).addClass('play').removeClass('disabled');
                    // 載入PDF
                    pdfDoc = pdfjsLib.getDocument(playFiles[pIndex].Url);
                    PDFPlay(pdfNextPage);
                break;
                // 不支援
                case ".wmvs":
                    console.log(`video 不支援該格式 ${playFiles[pIndex].Type}`)
                    removeCanNotPalyOfplayFile();
                    play();
                break;
                // 未測試
                default:
                    console.log(`${playFiles[pIndex].Type} -> 該格式尚未測試`)
                    removeCanNotPalyOfplayFile();
                    play();
                break;
            }
        }
        // #endregion

        // #region 輪播切換
        // 指定時間過後在切換
        function preNext(sec) {
            t_countdown = sec ? sec : slideTime;
        }
        // 切換下個播放項目
        function next() {
            // 內容只有一個就停止換頁
            //if (playFiles.length === 1) { return; }

            // 先結束前次播放
            // PDF
            if (pdfDoc) {
                cvClear();
                pdfDispose();
            }
            // 其他
            else {
                $('.play').removeAttr('src');   // 釋放圖片、影片、網頁
            }

            play();
        }
        // #endregion

        // #region 圖片播放
        function iPlay(url) {
            iPlayer.src = url;
        }
        // 讀取成功
        iPlayer.addEventListener('load', function () {
            preNext();
        });
        // 錯誤處理
        iPlayer.addEventListener('error', function () {
            console.log(`${this.src} -> 圖片無法開啟`);
            //removeCanNotPalyOfplayFile();
            next();
        });
        // #endregion

        // #region  影片播放
        function vPlay(url) {
            vPlayer.src = url;
        }
        // 影片結束換下個
        vPlayer.addEventListener('ended', function () {
            next();
        });
        // 影片無法播放換下個
        vPlayer.addEventListener('error', function () {
            console.log(`${this.src} -> 影片無法播放`);
            //removeCanNotPalyOfplayFile();
            next();
        });
        // #endregion

        // 網頁播放
        function ifPlay(url, second) {
            ifPlayer.src = url;
            preNext(second * 1000);
        }

        // #region  PDF播放
        // 讀取
        function PDFPlay(init) {
            pageNum = 0;
            pdfDoc.promise.then(
                function (_pdfDoc) {
                    pdfDoc = _pdfDoc;
                    init();
                },
                function (reason) {
                    _pdfDoc.cleanup();
                    next();         // 讀取失敗換下一個輪播
                }
            );
        }
        // 換頁
        function pdfNextPage() {
            if (++pageNum > pdfDoc.numPages) {
                next(); // 結束換下一個輪播
            }
            else {
                // Using promise to fetch the page
                pdfDoc.getPage(pageNum).then(
                    function (page) {
                        var viewport = page.getViewport({ 'scale': scale });
                        cvPlayer.height = viewport.height;
                        cvPlayer.width = viewport.width;
                        // Render PDF page into canvas context
                        // renderTask
                        page.cleanupAfterRender = true;
                        page.render({
                            'canvasContext': ctx,
                            'viewport': viewport
                        }).promise.then(
                            function (d) { },
                            function (reason) { }
                        ).finally(function () {
                            preNext();
                        });
                    },
                    function (reason) {
                        pdfNextPage(); // 換頁失敗直接下一頁
                    }
                );
            }
        }
        // 釋放PDF
        function pdfDispose() {
            if (pdfDoc) {
                cvClear();
                pdfDoc.destroy();
                pdfDoc = null;
            }
        }
        // 清空畫布
        function cvClear() {
            //player.getContext('2d').clearRect(0, 0, player.width, player.height);
            ctx.fillRect(0, 0, 0, 0);
            cvPlayer.height = 0;
            cvPlayer.width = 0;
        }
        // #endregion

        // 移除File
        function removeCanNotPalyOfplayFile() {
            playFiles.splice(pIndex, 1);
            --pIndex;
        }

        // 顯示目前節目表
        function show() {
            console.log(playFiles);
        }
        // #endregion

        // 錯誤訊息
        function writeMessage(message) {
            dMessage.innerHTML = `<h1 style=color:red>${message}</h1>`;
            // 有播放內容，60分鐘後再次載入
            if (playFiles) {
                if (playFiles.length === 0) {
                    dMessage.classList.remove('disabled');
                }
                else {
                    statusLight.className = 'status-yellow';
                }
                preRefresh();
            }
            // 無播放內容時1分鐘後再次載入
            else {
                statusLight.className = 'status-red';
                preRefresh(60);
            }
        }

        // #region 輪播器更新
        // 指定時間後更新
        function preRefresh(sec) {
            rt_countdown = sec ? sec : 3600; // 預設1小時
        }
        // 更新
        function refresh() {
            $.ajax({
                type: 'post',
                url: '@Url.Action("GetVersionInfo", "Api")',
                data: { 'C_NO': C_NO },
                dataType: 'json',
                success: function (data) {
                    if (data.Result === 'true') {
                        var carouselsInfo = JSON.parse(data.Data);
                        // 第一次載入
                        if (Version == undefined) {
                            readProgram(function () {
                                // 更新資訊
                                Version = carouselsInfo.Version;
                                UpdateTime = carouselsInfo.UpdateTime;
                                // 隱藏錯誤顯示
                                dMessage.classList.add('disabled');
                            });
                        }
                        // 版本更新
                        else if (Version != carouselsInfo.Version) {
                            // 重載頁面
                            reload();
                        }
                        // 節目更新
                        else if (UpdateTime != carouselsInfo.UpdateTime) {
                            readProgram(function () {
                                // 更新資訊
                                UpdateTime = carouselsInfo.UpdateTime;
                            });
                        }
                        // 無異動
                        else {
                            // 隔1小時更新
                            preRefresh();
                        }
                    }
                    else {
                        writeMessage(`<h1 style=color:red>輪播器更新失敗 : ${data.ErrorMessage}</h1>`);
                    }
                },
                error: function (xhr, status, error) {
                    writeMessage(`輪播器更新 AJAX 失敗 : ${error.message}`);
                }
            });
        }
        // #endregion

        // 檔案讀取
        function readProgram(init) {
            $.ajax({
                type: 'post',
                url: '@Url.Action("GetFilePath", "Api")',
                data: { 'C_NO': C_NO },
                dataType: 'json',
                success: function (data) {
                    if (data.Result === 'true') {

                        if (init) {
                            init();
                        }

                        prePlay(data.Data); // 開始輪播
                    }
                    else {
                        writeMessage(`<h1 style=color:red>檔案讀取失敗 : ${data.ErrorMessage}</h1>`);
                    }
                },
                error: function (xhr, status, error) {
                    writeMessage(`檔案讀取 AJAX 失敗 : ${error.message}`);
                }
            });
        }

        // 取得參數
        var url_value = decodeURI(window.location.search).substring(1);
        if (url_value) {
            url_value = url_value.split('&');
            url_value.forEach(function (value) {
                value = value.split('=');
                if (value[0] == 'p') {
                    C_NO = value[1]
                }
            });
        }

        // 開始播放
        if (C_NO) {
            refresh();
            player_click(); // 預設自動播放
        }
        else {
            $('#url_build').click(function () {
                window.location = location.origin + '/Watch?p=' + $('#url_C_NO').val();
            });
            clearInterval(t);
            clearInterval(rt);
        }

        // 使用者控制
        function player_click() {
            $('#ui_play').text(stop ? '暫停' : '播放');
            stop = !stop;
        }
        $('#ui_next').click(function () {
            if (pdfDoc) {
                pdfNextPage();
            }
            else if (pIndex >= 0) {
                next();
            }
        });
        $('#ui_previous').click(function () {
            if (pdfDoc && pageNum > 1) {
                pageNum -= 2;
                pdfNextPage();
            }
            else if (pIndex >= 0) {
                pIndex -= 2;
                if (pIndex < -1) {
                    pIndex = playFiles.length - 2;
                }
                next();
                if (pdfDoc) {
                    PDFPlay(function () {
                        pageNum = pdfDoc.numPages - 1
                        pdfNextPage();
                    });
                }
            }
        });
        $('#ui_play').click(function () {
            player_click();
        });
    </script>
</body>
</html>